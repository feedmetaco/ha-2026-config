# Bambu Lab Power Estimation
# Created by Agent 3 - December 7, 2025
# Enhanced power estimation with all printer states

template:
  - sensor:
      - name: "Bambu Lab Power"
        unique_id: bambu_lab_estimated_power
        device_class: power
        unit_of_measurement: "W"
        state_class: measurement
        state: >
          {% set status = states('sensor.print_status') | lower %}
          {% set stage = states('sensor.stage') | lower %}
          {% set progress = states('sensor.print_progress') | int(0) %}
          {% set bed_temp = states('sensor.bed_temp') | float(0) %}
          {% set nozzle_temp = states('sensor.nozzle_temp') | float(0) %}
          
          {# Offline #}
          {% if status in ['offline', 'unavailable', 'unknown'] %}
            0
          
          {# Idle/Standby #}
          {% elif status in ['idle', 'finish'] %}
            5
          
          {# Heating phases - high power #}
          {% elif 'heat' in stage or 'leveling' in stage %}
            {% if bed_temp < 50 and nozzle_temp < 150 %}
              280
            {% elif bed_temp < 60 or nozzle_temp < 200 %}
              250
            {% else %}
              220
            {% endif %}
          
          {# Active printing - variable by progress #}
          {% elif status in ['running', 'printing'] %}
            {% if progress < 5 %}
              220
            {% elif progress < 15 %}
              180
            {% elif progress < 85 %}
              150
            {% elif progress < 95 %}
              140
            {% else %}
              130
            {% endif %}
          
          {# Paused - maintaining temps #}
          {% elif status in ['pause', 'paused'] %}
            75
          
          {# Failed/Error - minimal #}
          {% elif status in ['failed', 'error'] %}
            10
          
          {# Default #}
          {% else %}
            5
          {% endif %}
        attributes:
          print_status: "{{ states('sensor.print_status') }}"
          stage: "{{ states('sensor.stage') }}"
          progress: "{{ states('sensor.print_progress') }}%"
          bed_temp: "{{ states('sensor.bed_temp') }}°C"
          nozzle_temp: "{{ states('sensor.nozzle_temp') }}°C"
          power_state: >
            {% set status = states('sensor.print_status') | lower %}
            {% if status in ['offline', 'unavailable'] %}
              Offline
            {% elif status in ['idle', 'finish'] %}
              Standby (5W)
            {% elif 'heat' in states('sensor.stage') | lower %}
              Heating (220-280W)
            {% elif status in ['running', 'printing'] %}
              Printing (130-220W)
            {% elif status in ['pause', 'paused'] %}
              Paused (75W)
            {% else %}
              Idle (5W)
            {% endif %}

  # History Stats for Runtime Tracking
  - platform: history_stats
    name: "Bambu Lab Printing Today"
    unique_id: bambu_lab_printing_today
    entity_id: sensor.print_status
    state: "running"
    type: time
    start: "{{ now().replace(hour=0, minute=0, second=0, microsecond=0) }}"
    end: "{{ now() }}"

  - platform: history_stats
    name: "Bambu Lab Printing This Week"
    unique_id: bambu_lab_printing_week
    entity_id: sensor.print_status
    state: "running"
    type: time
    start: "{{ as_timestamp(now().replace(hour=0, minute=0, second=0, microsecond=0)) - now().weekday() * 86400 }}"
    end: "{{ now() }}"

  - platform: history_stats
    name: "Bambu Lab Printing This Month"
    unique_id: bambu_lab_printing_month
    entity_id: sensor.print_status
    state: "running"
    type: time
    start: "{{ now().replace(day=1, hour=0, minute=0, second=0, microsecond=0) }}"
    end: "{{ now() }}"

