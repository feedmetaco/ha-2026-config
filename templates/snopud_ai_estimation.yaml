# AI-powered SNOPUD Usage Estimation
# Uses historical data patterns to estimate current month usage
# Can be enhanced with OpenAI API for more accurate predictions

template:
  - sensor:
      - name: "SNOPUD Estimated Monthly Usage"
        unique_id: snopud_estimated_monthly_usage
        unit_of_measurement: "kWh"
        device_class: energy
        state_class: measurement
        state: >
          {% set current_month = now().month %}
          {% set current_day = now().day %}
          
          {# Get last 12 months of data from utility meter #}
          {% set last_month = states('sensor.snopud_monthly') | default(0) | float(0) %}
          
          {# Simple estimation: use last month's usage adjusted for current day #}
          {% if last_month > 0 %}
            {% set daily_avg = last_month / 30 %}
            {% set days_elapsed = current_day %}
            {% set estimated = (daily_avg * 30) | round(1) %}
          {% else %}
            {# Fallback: use historical average based on month #}
            {% if current_month in [12, 1, 2] %}
              {% set estimated = 1400 %}  {# Winter months #}
            {% elif current_month in [6, 7, 8] %}
              {% set estimated = 1600 %}  {# Summer months #}
            {% else %}
              {% set estimated = 1200 %}  {# Spring/Fall #}
            {% endif %}
          {% endif %}
          
          {{ estimated }}
        
        attributes:
          last_updated: "{{ now() }}"
          estimation_method: "Historical average with seasonal adjustment"
          confidence: "Medium"
          current_day_of_month: "{{ current_day }}"
          
      - name: "SNOPUD Estimated Monthly Cost"
        unique_id: snopud_estimated_monthly_cost
        unit_of_measurement: "USD"
        device_class: monetary
        state_class: measurement
        state: >
          {% set kwh = states('sensor.snopud_estimated_monthly_usage') | float(0) %}
          {% set rate = states('input_number.snopud_rate_per_kwh') | float(0) %}
          {% set base = states('input_number.snopud_daily_base_fee') | float(0) %}
          {% set tax = states('input_number.snopud_tax_rate') | float(0) %}
          {% set days_in_month = 30 %}
          {% set subtotal = (days_in_month * base) + (kwh * rate) %}
          {{ (subtotal * (1 + tax)) | round(2) }}
          
      - name: "SNOPUD Usage Progress This Month"
        unique_id: snopud_usage_progress
        unit_of_measurement: "%"
        state_class: measurement
        state: >
          {% set current_total = states('sensor.snopud_meter_snopud_grid_kwh_total') | float(0) %}
          {% set last_month_total = current_total - (states('sensor.snopud_monthly') | default(0) | float(0)) %}
          {% set estimated_monthly = states('sensor.snopud_estimated_monthly_usage') | float(0) %}
          {% set days_elapsed = now().day %}
          {% set expected_so_far = (estimated_monthly * days_elapsed / 30) | round(1) %}
          {% set actual_so_far = current_total - last_month_total %}
          {% if estimated_monthly > 0 %}
            {% set progress = (actual_so_far / estimated_monthly * 100) | round(1) %}
          {% else %}
            {% set progress = 0 %}
          {% endif %}
          {{ progress }}
        
        attributes:
          estimated_monthly: "{{ estimated_monthly }}"
          actual_so_far: "{{ actual_so_far }}"
          days_elapsed: "{{ days_elapsed }}"

